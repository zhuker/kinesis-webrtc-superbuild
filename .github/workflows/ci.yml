name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

env:
  ANDROID_HOME: /Users/firefly/Library/Android/sdk
  AWS_KVS_LOG_LEVEL: 3

jobs:
  test-mac:
    name: macOS arm64
    runs-on: [self-hosted, macOS, ARM64]
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Build and test
        run: ./test-mac.sh

  test-docker:
    name: Linux arm64 (Docker)
    runs-on: [self-hosted, macOS, ARM64]
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Verify Docker
        run: docker info

      - name: Build and test
        run: bash ./test-docker.sh

  test-android:
    name: Android arm64 (native)
    runs-on: [self-hosted, macOS, ARM64]
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Start emulator
        run: bash ./emulator.sh start -f

      - name: Build, push, and test
        run: bash ./test-android.sh

      - name: Stop emulator
        if: always()
        run: bash ./emulator.sh stop || true

  test-android-app:
    name: Android arm64 (instrumented)
    runs-on: [self-hosted, macOS, ARM64]
    needs: test-android
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Start emulator
        run: bash ./emulator.sh start ; bash ./emulator.sh status

      - name: Build and test instrumented APK
        run: bash ./emulator.sh status ; bash ./test-android-app.sh

      - name: Stop emulator
        if: always()
        run: bash ./emulator.sh stop || true
