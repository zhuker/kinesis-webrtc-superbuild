name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

env:
  ANDROID_HOME: /Users/firefly/Library/Android/sdk
  AWS_KVS_LOG_LEVEL: 3

jobs:
  test-mac:
    name: macOS arm64
    runs-on: [self-hosted, macOS, ARM64]
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Build and test
        run: ./test-mac.sh

  test-docker:
    name: Linux arm64 (Docker)
    runs-on: [self-hosted, macOS, ARM64]
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Verify Docker
        run: docker info

      - name: Build and test
        run: bash ./test-docker.sh

  test-android:
    name: Android arm64 (native)
    runs-on: [self-hosted, macOS, ARM64]
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Start emulator
        run: bash ./emulator.sh start --avd "firefly-test-arm64" ; bash ./emulator.sh status

      - name: Build, push, and test
        run: bash ./test-android.sh

      - name: Stop emulator
        if: always()
        run: bash ./emulator.sh stop --avd "firefly-test-arm64" || true

  test-android-app:
    name: Android arm64 (instrumented)
    runs-on: [self-hosted, macOS, ARM64]
    needs: test-android
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Start emulator
        run: bash ./emulator.sh start --avd "firefly-test-arm64" ; bash ./emulator.sh status

      - name: Build and test instrumented APK
        run: bash ./emulator.sh status ; bash ./test-android-app.sh

      - name: Stop emulator
        if: always()
        run: bash ./emulator.sh stop --avd "firefly-test-arm64" || true

  test-mac-asan:
    name: macOS arm64 (ASan + UBSan)
    runs-on: [self-hosted, macOS, ARM64]
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Build and test with ASan
        run: ./test-mac.sh --asan

  test-docker-asan:
    name: Linux arm64 (ASan + UBSan, Docker)
    runs-on: [self-hosted, macOS, ARM64]
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Verify Docker
        run: docker info

      - name: Build and test with ASan
        run: bash ./test-docker.sh --asan

  test-docker-tsan:
    name: Linux arm64 (TSan, Docker)
    runs-on: [self-hosted, macOS, ARM64]
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Verify Docker
        run: docker info

      - name: Build and test with TSan
        run: bash ./test-docker.sh --tsan

  test-docker-filc:
    if: false # disabled for now
    name: Linux amd64 (fil-c, Docker)
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Verify Docker
        run: docker info

      - name: Build and test with fil-c
        run: bash ./test-docker.sh --filc

  test-android-asan:
    name: Android arm64 (ASan + UBSan)
    runs-on: [self-hosted, macOS, ARM64]
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Start emulator
        run: bash ./emulator.sh start --avd "firefly-test-arm64" ; bash ./emulator.sh status

      - name: Build, push, and test with ASan
        run: bash ./test-android.sh --asan

      - name: Stop emulator
        if: always()
        run: bash ./emulator.sh stop --avd "firefly-test-arm64" || true

  ci-pass:
    name: CI passed
    if: always()
    needs:
      - test-mac
      - test-mac-asan
      - test-docker
      - test-docker-asan
      - test-docker-tsan
      - test-android
      - test-android-app
      - test-android-asan
    runs-on: ubuntu-latest
    steps:
      - name: Check results
        run: |
          if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" || "${{ contains(needs.*.result, 'cancelled') }}" == "true" ]]; then
            echo "One or more jobs failed or were cancelled"
            exit 1
          fi
